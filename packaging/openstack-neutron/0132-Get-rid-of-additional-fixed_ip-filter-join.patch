From 9d8e00f60edf2b765ac8ccbf35eb46ea383302ee Mon Sep 17 00:00:00 2001
From: Kevin Benton <kevin@benton.pub>
Date: Mon, 9 Jan 2017 14:14:57 -0800
Subject: [PATCH 132/133] Get rid of additional fixed_ip filter join

Partial-Bug: #1649317
Change-Id: I692b4b85d539af3465a48eed83e40f2ad5b87e51
(cherry picked from commit f204728e37d4f18e741dfa295d6b3da5529efd6c)
Signed-off-by: Hunt Xu <mhuntxu@gmail.com>
---
 neutron/db/db_base_plugin_v2.py | 11 ++++++++---
 1 file changed, 8 insertions(+), 3 deletions(-)

diff --git a/neutron/db/db_base_plugin_v2.py b/neutron/db/db_base_plugin_v2.py
index f213438cc..e8b83929f 100644
--- a/neutron/db/db_base_plugin_v2.py
+++ b/neutron/db/db_base_plugin_v2.py
@@ -1452,11 +1452,16 @@ class NeutronDbPluginV2(neutron_plugin_base_v2.NeutronPluginBaseV2,
         ip_addresses = fixed_ips.get('ip_address')
         subnet_ids = fixed_ips.get('subnet_id')
         if ip_addresses or subnet_ids:
-            query = query.join(Port.fixed_ips)
             if ip_addresses:
-                query = query.filter(IPAllocation.ip_address.in_(ip_addresses))
+                query = query.filter(
+                    Port.fixed_ips.any(
+                        IPAllocation.ip_address.in_(ip_addresses)
+                    )
+                )
             if subnet_ids:
-                query = query.filter(IPAllocation.subnet_id.in_(subnet_ids))
+                query = query.filter(
+                    Port.fixed_ips.any(IPAllocation.subnet_id.in_(subnet_ids))
+                )
 
         query = self._apply_filters_to_query(query, Port, filters)
         if limit and page_reverse and sorts:
-- 
2.13.5 (Apple Git-94)

