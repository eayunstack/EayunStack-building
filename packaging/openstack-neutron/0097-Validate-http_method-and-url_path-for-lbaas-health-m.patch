From fe606e05ab63cfa566022bdea108e7b88d1c58df Mon Sep 17 00:00:00 2001
From: "cheng.tang" <tangch318@gmail.com>
Date: Wed, 19 Apr 2017 11:17:48 +0800
Subject: [PATCH 97/97] Validate http_method and url_path for lbaas health
 monitor

Inspiration from https://review.openstack.org/#/c/270629/

Fixes: redmine #9861

Signed-off-by: cheng.tang <tangch318@gmail.com>
Signed-off-by: Hunt Xu <mhuntxu@gmail.com>
---
 neutron/extensions/loadbalancer.py         |  7 +++++--
 neutron/services/loadbalancer/constants.py | 26 ++++++++++++++++++++++++++
 2 files changed, 31 insertions(+), 2 deletions(-)

diff --git a/neutron/extensions/loadbalancer.py b/neutron/extensions/loadbalancer.py
index 1e5796788..cbdf495ae 100644
--- a/neutron/extensions/loadbalancer.py
+++ b/neutron/extensions/loadbalancer.py
@@ -26,6 +26,7 @@ from neutron.common import exceptions as qexception
 from neutron import manager
 from neutron.plugins.common import constants
 from neutron.services import service_base
+from neutron.services.loadbalancer import constants as lb_const
 
 
 # Loadbalancer Exceptions
@@ -283,11 +284,13 @@ RESOURCE_ATTRIBUTE_MAP = {
                         'convert_to': attr.convert_to_int,
                         'is_visible': True},
         'http_method': {'allow_post': True, 'allow_put': True,
-                        'validate': {'type:string': None},
+                        'validate': {'type:values':
+                                     lb_const.SUPPORTED_HTTP_METHODS},
                         'default': 'GET',
                         'is_visible': True},
         'url_path': {'allow_post': True, 'allow_put': True,
-                     'validate': {'type:string': None},
+                     'validate': {'type:regex_or_none':
+                                  lb_const.SUPPORTED_URL_PATH},
                      'default': '/',
                      'is_visible': True},
         'expected_codes': {'allow_post': True, 'allow_put': True,
diff --git a/neutron/services/loadbalancer/constants.py b/neutron/services/loadbalancer/constants.py
index 0f834467b..5e414fd43 100644
--- a/neutron/services/loadbalancer/constants.py
+++ b/neutron/services/loadbalancer/constants.py
@@ -26,6 +26,32 @@ HEALTH_MONITOR_TCP = 'TCP'
 HEALTH_MONITOR_HTTP = 'HTTP'
 HEALTH_MONITOR_HTTPS = 'HTTPS'
 
+HTTP_METHOD_GET = 'GET'
+HTTP_METHOD_HEAD = 'HEAD'
+HTTP_METHOD_POST = 'POST'
+HTTP_METHOD_PUT = 'PUT'
+HTTP_METHOD_DELETE = 'DELETE'
+HTTP_METHOD_TRACE = 'TRACE'
+HTTP_METHOD_OPTIONS = 'OPTIONS'
+HTTP_METHOD_CONNECT = 'CONNECT'
+HTTP_METHOD_PATCH = 'PATCH'
+
+SUPPORTED_HTTP_METHODS = (HTTP_METHOD_GET, HTTP_METHOD_HEAD, HTTP_METHOD_POST,
+                          HTTP_METHOD_PUT, HTTP_METHOD_DELETE,
+                          HTTP_METHOD_TRACE, HTTP_METHOD_OPTIONS,
+                          HTTP_METHOD_CONNECT, HTTP_METHOD_PATCH)
+
+# URL path regex according to RFC 3986
+# Format: path = "/" *( "/" segment )
+#         segment       = *pchar
+#         pchar         = unreserved / pct-encoded / sub-delims / ":" / "@"
+#         unreserved    = ALPHA / DIGIT / "-" / "." / "_" / "~"
+#         pct-encoded   = "%" HEXDIG HEXDIG
+#         sub-delims    = "!" / "$" / "&" / "'" / "(" / ")"
+#                         / "*" / "+" / "," / ";" / "="
+SUPPORTED_URL_PATH = (
+        "^(/([a-zA-Z0-9-._~!$&\'()*+,;=:@]|(%[a-fA-F0-9]{2}))*)+$")
+
 SESSION_PERSISTENCE_SOURCE_IP = 'SOURCE_IP'
 SESSION_PERSISTENCE_HTTP_COOKIE = 'HTTP_COOKIE'
 SESSION_PERSISTENCE_APP_COOKIE = 'APP_COOKIE'
-- 
2.12.2

