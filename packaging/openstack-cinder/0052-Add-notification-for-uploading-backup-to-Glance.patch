From c57608dd53eb8ceb75a4093d39d685c660f1dc9b Mon Sep 17 00:00:00 2001
From: Zhao Chao <zhaochao1984@gmail.com>
Date: Thu, 28 Sep 2017 10:49:02 +0800
Subject: [PATCH 52/54] Add notification for uploading backup to Glance.

Fixes: http://192.168.15.2/issues/10111

Change-Id: I6adeb8af2a2647fc7e99fbc52821f6a2ea925733
Signed-off-by: Zhao Chao <zhaochao1984@gmail.com>
(cherry picked from commit edf9101a2265d2cdf6b831e519cf01ac49b2b7a5)
---
 cinder/backup/manager.py | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/cinder/backup/manager.py b/cinder/backup/manager.py
index 9158d0f3d..0597ddd4c 100644
--- a/cinder/backup/manager.py
+++ b/cinder/backup/manager.py
@@ -432,6 +432,7 @@ class BackupManager(manager.SchedulerDependentManager):
                    'image_id: %(image_id)s.'),
                  {'backup_id': backup['id'], 'image_id': image_meta['id']})
         self.db.backup_update(context, backup['id'], {'host': self.host})
+        self._notify_about_backup_usage(context, backup, "upload.start")
 
         payload = {'backup_id': backup['id'], 'image_id': image_meta['id']}
 
@@ -483,12 +484,13 @@ class BackupManager(manager.SchedulerDependentManager):
             with excutils.save_and_reraise_exception():
                 payload['message'] = unicode(error)
         finally:
-            self.db.backup_update(context, backup['id'],
-                                  {'status': 'available'})
+            backup = self.db.backup_update(context, backup['id'],
+                                           {'status': 'available'})
 
         LOG.info(_('Upload backup finished, backup %(backup_id)s uploaded'
                    ' to glance %(image_id)s.') %
                  {'backup_id': backup['id'], 'image_id': image_meta['id']})
+        self._notify_about_backup_usage(context, backup, "upload.end")
 
     def restore_backup(self, context, backup_id, volume_id):
         """Restore volume backups from configured backup service."""
-- 
2.15.0

